# Tài liệu Horror Bot (v3)

## 1. Tổng quan

Project này là một bot Discord cho phép người dùng chơi một trò chơi phiêu lưu kinh dị dạng text (text-based adventure). Bot sử dụng một Large Language Model (LLM) chạy local (`qwen2.5-1.5b-instruct-q4_k_m.gguf`) để tạo ra các mô tả, sự kiện, và một hệ thống "Quy tắc Sinh tồn" (Quái Đàm) phức tạp.

Kiến trúc của bot được thiết kế theo module để dễ dàng quản lý và mở rộng, tách biệt rõ ràng giữa logic, nội dung game và chỉ dẫn AI.

## 2. Kiến trúc

Dự án được xây dựng trên một kiến trúc 4 lớp rõ ràng:

1.  **Lớp Trình bày (Presentation Layer):**
    *   **Thành phần:** `discord.py` và các `cogs`.
    *   **Mô tả:** Xử lý mọi tương tác với người dùng qua Discord (slash commands, buttons, messages).
    *   **File chính:** `main.py`, `cogs/game_commands.py`.

2.  **Lớp Logic Nghiệp vụ (Business Logic Layer):**
    *   **Thành phần:** Các "services" trong `horror_bot/services`.
    *   **Mô tả:** Bộ não của ứng dụng, xử lý toàn bộ logic của trò chơi.
        *   `game_engine.py`: Điều phối chính, xử lý và chấm điểm hành động của người chơi.
        *   `llm_service.py`: Cầu nối duy nhất đến LLM, chịu trách nhiệm gọi và xử lý output từ model.
    *   **File chính:** `services/game_engine.py`, `services/llm_service.py`.

3.  **Lớp Chỉ dẫn AI (AI Prompt Layer):**
    *   **Thành phần:** Thư mục `horror_bot/prompts`.
    *   **Mô tả:** Chứa các file `.txt` đóng vai trò là các mẫu chỉ dẫn (prompt templates) cho LLM. Việc tách prompt ra khỏi code giúp dễ dàng tinh chỉnh hành vi của AI.
        *   `generate_dark_rules.txt`: Yêu cầu LLM tạo ra bộ 10 quy tắc công khai và 10 quy tắc ngầm dưới dạng JSON.
        *   `check_rule_violation.txt`: Yêu cầu LLM phán xét xem hành động của người chơi có vi phạm quy tắc ngầm không.
    *   **File chính:** `prompts/*.txt`.

4.  **Lớp Dữ liệu & Nội dung (Data & Content Layer):**
    *   **Thành phần:** Database (`aiosqlite`) và thư mục `horror_bot/data`.
    *   **Mô tả:**
        *   **Database:** `db_manager.py` quản lý database SQLite. `schema.sql` định nghĩa cấu trúc các bảng, bao gồm `game_rules` để lưu các quy tắc cho mỗi ván chơi.
        *   **Nội dung Game (`data/`):** Chứa toàn bộ nội dung tĩnh của game, giúp dễ dàng chỉnh sửa mà không cần can thiệp vào code.
            *   `data/scenarios/*.json`: Định nghĩa cấu trúc bản đồ, các phòng và mối liên kết.
            *   `data/entities/*.txt`: Danh sách các loại sinh vật, ma quỷ có thể xuất hiện.
            *   `data/lore/{scenario_name}/`: **(Mới)** Mỗi kịch bản có một thư mục riêng chứa:
                *   `greeting.txt`: Một câu chào ngắn, giới thiệu nhanh về bối cảnh.
                *   `lore.txt`: Đoạn văn lore chi tiết, được dùng làm nội dung dự phòng (fallback) khi LLM không thể tạo lore mới.

## 3. Luồng hoạt động

1.  **Bắt đầu game (`/newgame`):**
    *   `game_commands.py` tạo `game_id` và các kênh Discord.
    *   **Lấy Lời chào:** `llm_service.generate_simple_greeting()` được gọi. Hàm này sẽ đọc trực tiếp file `data/lore/{scenario}/greeting.txt` để lấy lời chào nhanh.
    *   **Sinh Quy tắc:** `llm_service.generate_dark_rules()` được gọi để LLM tạo ra 20 quy tắc (10 công khai, 10 ngầm) và lưu vào database.
    *   10 quy tắc công khai được hiển thị cho người chơi.
    *   **Sinh Lore chi tiết (nền):** `llm_service.generate_world_lore()` được gọi. Hàm này sẽ dùng LLM để tạo lore mới, nhưng nếu thất bại, nó sẽ đọc nội dung từ file `data/lore/{scenario}/lore.txt` làm phương án dự phòng.

2.  **Người chơi hành động:**
    *   Người chơi gõ lệnh vào kênh riêng.
    *   `game_engine.py` nhận lệnh và bắt đầu quy trình xử lý 2 bước với LLM:
        1.  **Mô tả kết quả:** Gọi `llm_service.process_player_action()` để LLM mô tả chuyện gì xảy ra.
        2.  **Phán xét vi phạm:** Gọi `llm_service.check_rule_violation()` để LLM thứ hai (trong vai trò giám khảo) quyết định xem hành động đó có vi phạm quy tắc ngầm nào không.
    *   Nếu có vi phạm, người chơi sẽ bị trừ điểm Sanity (tỉnh táo) và nhận được một thông báo ẩn ý.

## 4. Cài đặt và Chạy

Quy trình cài đặt không thay đổi:
1.  Tạo và kích hoạt môi trường ảo (`.venv`).
2.  Cài đặt thư viện: `pip install -r horror_bot/requirements.txt`.
3.  Tải Model LLM: `python horror_bot/download_model.py`.
4.  Tạo file `.env` trong `horror_bot/` và thêm `DISCORD_BOT_TOKEN`.
5.  Chạy Bot: `python horror_bot/main.py`.