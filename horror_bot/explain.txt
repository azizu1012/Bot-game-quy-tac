================================================================================
    PHÃ‚N TÃCH Cáº¤U TRÃšC Dá»° ÃN: HORROR BOT - DISCORD HORROR GAME
    Full Stack Python Project - discord.py + SQLite + Local LLM (Per-User Sessions)
================================================================================

ğŸ¯ Tá»”NG QUAN Dá»° ÃN
================================================================================
Dá»± Ã¡n lÃ  má»™t Discord Bot chÆ¡i game kinh dÃ­ há»£p tÃ¡c (multiplayer horror game).
NgÆ°á»i chÆ¡i tham gia cÃ¡c phÃ²ng game trÃªn Discord, tÆ°Æ¡ng tÃ¡c qua free-form text
prompts Ä‘á»ƒ sinh tá»“n trong cÃ¡c ká»‹ch báº£n kinh dÃ­. Bot sá»­ dá»¥ng:
- Local LLM (llama-cpp-python) vá»›i per-user isolation Ä‘á»ƒ sinh diá»…n biáº¿n, mÃ´ táº£ cáº£nh
- SQLite (aiosqlite) Ä‘á»ƒ lÆ°u tráº¡ng thÃ¡i game, ngÆ°á»i chÆ¡i, conversation history
- discord.py Ä‘á»ƒ quáº£n lÃ½ bot, commands, UI

Kiáº¿n trÃºc hiá»‡n táº¡i: Há»‡ thá»‘ng 3-tier channels (Lobby â†’ Dashboard â†’ Private Per-User),
per-user LLM conversation history (10-message rolling window), free-form text actions,
automatic encounter detection, real-time dashboard updates.

================================================================================
ğŸ“ Cáº¤U TRÃšC THÆ¯ Má»¤C & CÃC FILE CHá»¦ Yáº¾U
================================================================================

â”Œâ”€ horror_bot/ (ThÆ° má»¥c gá»‘c dá»± Ã¡n)
â”‚
â”œâ”€ main.py â­ ENTRY POINT
â”‚  â””â”€ Vai trÃ²: Khá»Ÿi táº¡o Discord Bot, táº£i Database, táº£i LLM
â”‚  â””â”€ Chá»©c nÄƒng chÃ­nh:
â”‚     â€¢ Táº¡o bot instance vá»›i discord.py
â”‚     â€¢ Event on_ready: Táº£i Database schema, Load LLM model
â”‚     â€¢ Táº£i 3 cogs: admin_commands, game_commands, game_ui
â”‚     â€¢ Khá»Ÿi Ä‘á»™ng bot vá»›i token tá»« .env
â”‚
â”œâ”€ config.py âš™ï¸ Cáº¤U HÃŒNH TOÃ€N Cá»¤C
â”‚  â””â”€ Bao gá»“m:
â”‚     â€¢ TURN_TIME_SECONDS = 60 (thá»i gian má»—i lÆ°á»£t)
â”‚     â€¢ THINKING_PHASE_SECONDS = 30 (tháº£o luáº­n giá»¯a lÆ°á»£t)
â”‚     â€¢ DEFAULT_MAP_CONFIG: Cáº¥u hÃ¬nh maps cho 12 ká»‹ch báº£n
â”‚       - Má»—i ká»‹ch báº£n cÃ³ min/max floors, min/max rooms per floor
â”‚       - VÃ­ dá»¥: Asylum (4-6 táº§ng), Factory (5-7 táº§ng), Abyss (10-15 táº§ng)
â”‚
â”œâ”€ requirements.txt ğŸ“¦ DEPENDENCIES
â”‚  â”œâ”€ discord.py (Discord Bot framework)
â”‚  â”œâ”€ python-dotenv (Load .env file)
â”‚  â”œâ”€ aiosqlite (Async SQLite driver)
â”‚  â”œâ”€ llama-cpp-python (Local LLM inference)
â”‚  â””â”€ huggingface-hub (Download models)
â”‚
â”œâ”€ .env ğŸ” BIáº¾N MÃ”I TRÆ¯á»œNG (khÃ´ng trong repo)
â”‚  â”œâ”€ DISCORD_TOKEN (Bot token tá»« Discord)
â”‚  â”œâ”€ LLM_MODEL_PATH (ÄÆ°á»ng dáº«n file .gguf model)
â”‚  â”œâ”€ LLM_N_THREADS (Sá»‘ CPU threads cho LLM)
â”‚  â””â”€ LLM_CONTEXT_SIZE (Context window kÃ­ch thÆ°á»›c)
â”‚
â”œâ”€ setup.sh ğŸš€ SCRIPT KHá»I Äá»˜NG (Bash script)
â”‚  â””â”€ Cáº¥u hÃ¬nh Python venv, install dependencies, táº£i model
â”‚
â”œâ”€ download_model.py ğŸ¤– DOWNLOAD LLM MODEL
â”‚  â””â”€ Download mÃ´ hÃ¬nh Qwen-1.5B GGUF tá»« Hugging Face
â”‚  â””â”€ LÆ°u táº¡i Ä‘Æ°á»ng dáº«n Ä‘Æ°á»£c chá»‰ Ä‘á»‹nh trong .env
â”‚
â”œâ”€ database/ ğŸ—„ï¸ QUáº¢N LÃ DATABASE
â”‚  â”œâ”€ schema.sql: SQL schema Ä‘á»‹nh nghÄ©a báº£ng
â”‚  â”‚  â”œâ”€ active_games: LÆ°u game sessions Ä‘ang cháº¡y
â”‚  â”‚  â”‚  â””â”€ Columns: game_id (UUID), lobby_channel_id, dashboard_channel_id,
â”‚  â”‚  â”‚              dashboard_message_id, host_id, game_creator_id,
â”‚  â”‚  â”‚              scenario_type, game_code, is_active,
â”‚  â”‚  â”‚              setup_by_admin_id
â”‚  â”‚  â”‚  â””â”€ Thay Ä‘á»•i tá»« v3: Removed turn_deadline_ts, waiting_room_stage,
â”‚  â”‚  â”‚                      turn-based columns (chuyá»ƒn sang continuous free-form)
â”‚  â”‚  â”‚  â””â”€ ThÃªm: 3-tier channel IDs, dashboard_message_id (for real-time updates)
â”‚  â”‚  â”œâ”€ game_setups: Config admin (category Ä‘á»ƒ táº¡o rooms)
â”‚  â”‚  â”‚  â””â”€ Columns: setup_id, guild_id, category_id, created_by, created_at
â”‚  â”‚  â”œâ”€ game_maps: LÆ°u map data (JSON)
â”‚  â”‚  â”‚  â””â”€ Columns: game_id, map_data (JSON structure)
â”‚  â”‚  â”œâ”€ players: ThÃ´ng tin ngÆ°á»i chÆ¡i (REDESIGNED)
â”‚  â”‚  â”‚  â””â”€ Columns: user_id, game_id, hp, sanity, agi, acc,
â”‚  â”‚  â”‚              background_id, background_name, background_description,
â”‚  â”‚  â”‚              current_location_id, location_name (cached),
â”‚  â”‚  â”‚              inventory (JSON items),
â”‚  â”‚  â”‚              private_channel_id (per-user isolation),
â”‚  â”‚  â”‚              llm_conversation_history (JSON, rolling 10 messages),
â”‚  â”‚  â”‚              is_ready (boolean), last_action_result (JSON)
â”‚  â”‚  â”‚  â””â”€ Thay Ä‘á»•i tá»« v3: Removed turn-based columns (has_acted, action_this_turn,
â”‚  â”‚  â”‚                      confirmed_action, waiting_room_confirmed, voted_end_game)
â”‚  â”‚  â”‚  â””â”€ ThÃªm: private_channel_id, llm_conversation_history, location_name, is_ready
â”‚  â”‚  â”œâ”€ game_rules: Quy táº¯c game (10 public + 10 hidden)
â”‚  â”‚  â”‚  â””â”€ Columns: rule_id, game_id, rule_text, is_public,
â”‚  â”‚  â”‚              rule_type (lore/mechanic/clue/warning),
â”‚  â”‚  â”‚              discovery_requirement
â”‚  â”‚  â”œâ”€ game_context: Context cho LLM penalties
â”‚  â”‚  â”‚  â””â”€ Columns: context_id, game_id, scenario_type,
â”‚  â”‚  â”‚             current_threat_level, active_dangers (JSON),
â”‚  â”‚  â”‚             recent_events (JSON)
â”‚  â”‚  â””â”€ player_encounters: LÆ°u encounter log khi players gáº·p nhau (NEW)
â”‚  â”‚     â””â”€ Columns: encounter_id, game_id, location_id, player_ids (JSON array),
â”‚  â”‚                  encounter_text (LLM-generated), timestamp
â”‚  â”‚
â”‚  â””â”€ db_manager.py: Async database helper functions
â”‚     â”œâ”€ execute_query(): Cháº¡y SQL query vá»›i aiosqlite
â”‚     â”œâ”€ Player management: check_player_in_game(), get_player_current_game()
â”‚     â”œâ”€ Game management: get_game_creator(), cleanup_game()
â”‚     â”œâ”€ Rules system: get_game_rules(), discover_hidden_rule()
â”‚     â”œâ”€ Sanity system: update_player_sanity(), get_threat_level()
â”‚     â””â”€ NEW V4 Helper Functions:
â”‚        â”œâ”€ get_players_at_location(game_id, location_id):
â”‚        â”‚  â””â”€ Returns [user_id, background_name, private_channel_id, hp]
â”‚        â”‚  â””â”€ DÃ¹ng Ä‘á»ƒ detect encounters (2+ players táº¡i cÃ¹ng location)
â”‚        â”œâ”€ get_game_by_id(game_id): Fetch game record by UUID
â”‚        â”œâ”€ update_player_stats(user_id, game_id, hp_change, sanity_change):
â”‚        â”‚  â””â”€ Atomic update vá»›i clamping (0-100)
â”‚        â”œâ”€ append_to_llm_history(user_id, game_id, role, message):
â”‚        â”‚  â””â”€ ThÃªm message vÃ o conversation history, giá»¯ last 10
â”‚        â”œâ”€ get_llm_history(user_id, game_id):
â”‚        â”‚  â””â”€ Retrieves JSON conversation history (list cá»§a dict)
â”‚        â””â”€ record_encounter(game_id, location_id, player_ids, encounter_text):
â”‚           â””â”€ Logs encounter to player_encounters table
â”‚
â”œâ”€ cogs/ ğŸ”Œ BOT COMMANDS & UI (Discord.py Cogs - modular extensions)
â”‚  â”œâ”€ admin_commands.py: Admin-only commands
â”‚  â”‚  â”œâ”€ /sync: Äá»“ng bá»™ slash commands toÃ n cá»¥c hoáº·c per-guild
â”‚  â”‚  â””â”€ /setup [category]: Admin thiáº¿t láº­p Category Ä‘á»ƒ táº¡o game rooms
â”‚  â”‚     â””â”€ LÆ°u vÃ o game_setups table, kiá»ƒm tra admin permission
â”‚  â”‚
â”‚  â”œâ”€ game_commands.py: Game flow commands (REDESIGNED FOR FREE-FORM ACTIONS)
â”‚  â”‚  â”œâ”€ /newgame [scenario]: Táº¡o phÃ²ng game má»›i (3-tier channel architecture)
â”‚  â”‚  â”‚  â”œâ”€ Kiá»ƒm tra admin setup tá»“n táº¡i (náº¿u khÃ´ng => lá»—i)
â”‚  â”‚  â”‚  â”œâ”€ Táº¡o Category náº¿u cáº§n
â”‚  â”‚  â”‚  â”œâ”€ Tier 1 (Lobby Channel): Hiá»ƒn thá»‹ lore, button START
â”‚  â”‚  â”‚  â”‚  â””â”€ Táº¥t cáº£ players trong game cÃ³ thá»ƒ xem (read-only lore updates)
â”‚  â”‚  â”‚  â”œâ”€ Tier 2 (Dashboard Channel): Read-only player stats
â”‚  â”‚  â”‚  â”‚  â””â”€ Edits in-place, khÃ´ng spam (1 message updated continuously)
â”‚  â”‚  â”‚  â”œâ”€ Generate greeting + map, lÆ°u game_maps
â”‚  â”‚  â”‚  â”œâ”€ Sinh 20 quy táº¯c (10 public, 10 hidden)
â”‚  â”‚  â”‚  â””â”€ ThÃªm creator nhÆ° player Ä‘áº§u tiÃªn (is_ready = 0)
â”‚  â”‚  â”‚
â”‚  â”‚  â”œâ”€ START Button Handler (_start_game_for_player):
â”‚  â”‚  â”‚  â”œâ”€ Táº¡o Tier 3 (Private Channel): private-[player-name]-[random]
â”‚  â”‚  â”‚  â”œâ”€ Update players.private_channel_id
â”‚  â”‚  â”‚  â”œâ”€ Send welcome message + initial scene description
â”‚  â”‚  â”‚  â””â”€ Mark is_ready = 1
â”‚  â”‚  â”‚
â”‚  â”‚  â”œâ”€ on_message Listener (MESSAGE ROUTING):
â”‚  â”‚  â”‚  â”œâ”€ Intercepts messages trong private-* channels
â”‚  â”‚  â”‚  â”œâ”€ Routes to game_engine.process_free_text_action()
â”‚  â”‚  â”‚  â”œâ”€ No emoji reactions, pure natural language
â”‚  â”‚  â”‚  â””â”€ Example: Player types "TÃ´i tÃ¬m kiáº¿m trong phÃ²ng"
â”‚  â”‚  â”‚             => LLM processes, updates stats, returns description
â”‚  â”‚  â”‚
â”‚  â”‚  â”œâ”€ /endgame: Káº¿t thÃºc game
â”‚  â”‚  â”‚  â”œâ”€ Náº¿u creator: End ngay, cleanup all data
â”‚  â”‚  â”‚  â””â”€ Náº¿u player khÃ¡c: Vote (50%+ Ä‘á»ƒ pass), cleanup khi pass
â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€ Helper functions:
â”‚  â”‚     â”œâ”€ _add_player_to_game(): ThÃªm player vá»›i default profile
â”‚  â”‚     â”œâ”€ _start_game_for_player(): Create Tier 3 channel
â”‚  â”‚     â””â”€ chunk_text(): Split text cho 2000 char limit
â”‚  â”‚
â”‚  â””â”€ game_ui.py: UI components & embeds (UNCHANGED)
â”‚     â”œâ”€ create_progress_bar(): Text-based progress bar [â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘]
â”‚     â”œâ”€ Embed classes (if needed)
â”‚     â””â”€ Helper functions
â”‚
â”œâ”€ services/ ğŸ”§ GAME LOGIC & AI
â”‚  â”œâ”€ llm_service.py: LLM inference (PER-USER ISOLATION)
â”‚  â”‚  â”œâ”€ load_llm(): Táº£i model GGUF tá»« Ä‘Æ°á»ng dáº«n (load once in main.py)
â”‚  â”‚  â”‚  â””â”€ Qwen-1.5B model, n_ctx=8192, n_threads tá»« config
â”‚  â”‚  â”‚
â”‚  â”‚  â”œâ”€ async process_player_action(action_text, system_prompt, conversation_history):
â”‚  â”‚  â”‚  â”œâ”€ Per-player system prompt (includes scenario context, current location, stats)
â”‚  â”‚  â”‚  â”œâ”€ Builds prompt vá»›i last 5 messages tá»« conversation history
â”‚  â”‚  â”‚  â”œâ”€ Calls LLM with Qwen chat template
â”‚  â”‚  â”‚  â”œâ”€ Returns JSON: {success, description, hp_change, sanity_change,
â”‚  â”‚  â”‚  â”‚                  new_location_id, discovered_items}
â”‚  â”‚  â”‚  â”œâ”€ 500 token max output, 30s timeout
â”‚  â”‚  â”‚  â””â”€ Ensures each player's action context lÃ  isolated (no cross-talk)
â”‚  â”‚  â”‚
â”‚  â”‚  â”œâ”€ async generate_simple_greeting(scenario_type):
â”‚  â”‚  â”‚  â””â”€ Preset dict (no LLM, instant greeting)
â”‚  â”‚  â”‚
â”‚  â”‚  â”œâ”€ async generate_encounter(action_description, player_name, other_players, scenario_type):
â”‚  â”‚  â”‚  â””â”€ LLM generates 2-3 sentence encounter text when players meet
â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€ async describe_scene(keywords):
â”‚  â”‚     â””â”€ Optional narrative generation (50 words, for lobby lore updates)
â”‚  â”‚
â”‚  â”œâ”€ game_engine.py: Free-form action processing (6-STEP PIPELINE)
â”‚  â”‚  â”œâ”€ async process_free_text_action(player_id, game_id, action_text, channel, bot):
â”‚  â”‚  â”‚  â”œâ”€ Step 1: Gather context
â”‚  â”‚  â”‚  â”‚  â””â”€ Query player stats, inventory, location, llm_conversation_history
â”‚  â”‚  â”‚  â”œâ”€ Step 2: Call LLM with per-player DM prompt
â”‚  â”‚  â”‚  â”‚  â””â”€ LLM receives: location description, player stats, inventory, last 5 messages
â”‚  â”‚  â”‚  â”œâ”€ Step 3: Parse LLM JSON response, update DB atomically
â”‚  â”‚  â”‚  â”‚  â””â”€ Update hp, sanity, location, inventory, conversation_history
â”‚  â”‚  â”‚  â”œâ”€ Step 4: Check for encounters
â”‚  â”‚  â”‚  â”‚  â””â”€ get_players_at_location() => if 2+ => generate_encounter()
â”‚  â”‚  â”‚  â”œâ”€ Step 5: Update real-time dashboard
â”‚  â”‚  â”‚  â”‚  â””â”€ update_game_dashboard() edits existing message
â”‚  â”‚  â”‚  â””â”€ Step 6: Send response to player's private channel
â”‚  â”‚  â”‚     â””â”€ Formatted embed with stats delta, description
â”‚  â”‚  â”‚
â”‚  â”‚  â”œâ”€ async update_game_dashboard(game_id, bot):
â”‚  â”‚  â”‚  â”œâ”€ Fetches táº¥t cáº£ players in game
â”‚  â”‚  â”‚  â”œâ”€ Builds embed with HP/Sanity bars, location names
â”‚  â”‚  â”‚  â”œâ”€ Edits existing dashboard message (or creates if new)
â”‚  â”‚  â”‚  â””â”€ Runs continuously after each action (real-time updates)
â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€ create_progress_bar(current, max, width=10):
â”‚  â”‚     â””â”€ Returns text-based bar: [â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘]
â”‚  â”‚
â”‚  â”œâ”€ map_generator.py: Sinh map procedurally (UNCHANGED)
â”‚  â”‚  â”œâ”€ MapNode class: id, room_type, description, connections, entities, events
â”‚  â”‚  â”œâ”€ MapStructure class: scenario_name, nodes dict, start_node_id
â”‚  â”‚  â””â”€ generate_map_structure(scenario_file): Táº¡o map tá»« config
â”‚  â”‚
â”‚  â”œâ”€ background_service.py: Player profile & stats (UNCHANGED)
â”‚  â”‚  â”œâ”€ load_backgrounds(): Táº£i tá»« data/backgrounds.json
â”‚  â”‚  â”œâ”€ generate_random_background(): Random background
â”‚  â”‚  â””â”€ create_player_profile(scenario_type): Profile khi join
â”‚  â”‚
â”‚  â””â”€ scenario_generator.py: Sinh diá»…n biáº¿n qua AI (OPTIONAL - Future use)
â”‚
â””â”€ data/ ğŸ“Š Dá»® LIá»†U GAME
   â”œâ”€ backgrounds.json: Danh sÃ¡ch professions
   â”‚  â””â”€ CÃ¡c background sáºµn cÃ³ (police, doctor, student, etc)
   â”‚  â””â”€ Format: [{id, name, description, stats}]
   â”‚
   â”œâ”€ scenarios/: 12 ká»‹ch báº£n khÃ¡c nhau
   â”‚  â”œâ”€ asylum.json (Bá»‡nh viá»‡n tÃ¢m tháº§n)
   â”‚  â”œâ”€ factory.json (NhÃ  mÃ¡y cÅ© ká»¹)
   â”‚  â”œâ”€ ghost_village.json (LÃ ng hoang váº¯ng)
   â”‚  â”œâ”€ cursed_mansion.json (LÃ¢u Ä‘Ã i bá»‹ nguyá»n)
   â”‚  â”œâ”€ mine.json (Má» than sÃ¢u)
   â”‚  â”œâ”€ prison.json (NhÃ  tÃ¹ cÅ©)
   â”‚  â”œâ”€ abyss.json (Vá»±c tháº³m)
   â”‚  â”œâ”€ dead_forest.json (Rá»«ng cháº¿t)
   â”‚  â”œâ”€ research_hospital.json (Bá»‡nh viá»‡n nghiÃªn cá»©u)
   â”‚  â”œâ”€ ghost_ship.json (Chiáº¿c tÃ u bá» hoang)
   â”‚  â”œâ”€ hotel.json (KhÃ¡ch sáº¡n ma Ã¡m)
   â”‚  â””â”€ hospital.json (Bá»‡nh viá»‡n thÆ°á»ng)
   â”‚  â””â”€ Format JSON: {rooms, monsters, items, events, difficulty, etc}
   â”‚
   â”œâ”€ descriptions/:
   â”‚  â”œâ”€ rooms.txt: MÃ´ táº£ room dÃ¹ng cho procedural generation
   â”‚  â””â”€ smells.txt: MÃ´ táº£ mÃ¹i cáº£m giÃ¡c mÃ´i trÆ°á»ng
   â”‚
   â””â”€ entities/: NPC/Creature database
      â”œâ”€ creatures.txt: QuÃ¡i váº­t cÃ³ thá»ƒ gáº·p
      â””â”€ ghosts.txt: CÃ¡c con ma/tháº§n thoáº¡i

================================================================================
ğŸ® GAME FLOW (Quy trÃ¬nh chÆ¡i - Free-Form Per-User Architecture)
================================================================================

1. SETUP PHASE (Admin)
   User: /setup [category]
   Bot: LÆ°u category_id vÃ o game_setups table (guild-specific)
   
2. CREATE GAME PHASE (3-TIER CHANNELS)
   User: /newgame [scenario]
   Bot:
   â”œâ”€ Kiá»ƒm tra admin setup tá»“n táº¡i
   â”œâ”€ Táº¡o Category náº¿u cáº§n
   â”œâ”€ Tier 1 - Lobby Channel: Lore + START button
   â”‚  â””â”€ MÃ´ táº£ ká»‹ch báº£n, táº¥t cáº£ players xem lore
   â”œâ”€ Tier 2 - Dashboard Channel: Read-only stats
   â”‚  â””â”€ Edits in-place, real-time player stats (HP, Sanity, Location)
   â”œâ”€ Sinh map structure, lÆ°u game_maps (game_id UUID)
   â”œâ”€ Sinh 20 quy táº¯c (10 public, 10 hidden)
   â”œâ”€ ThÃªm creator nhÆ° player Ä‘áº§u tiÃªn (is_ready = 0)
   â””â”€ Gá»­i join menu vá»›i START button

3. PLAYER JOIN & START PHASE
   User: Nháº¥n START button trong lobby
   Bot:
   â”œâ”€ Táº¡o Tier 3 - Private Channel: private-[player-name]-[random]
   â”œâ”€ Update players.private_channel_id, is_ready = 1
   â”œâ”€ Send welcome message + initial scene description
   â”œâ”€ Initialize llm_conversation_history = []
   â””â”€ Ready Ä‘á»ƒ nháº­n free-text actions

4. FREE-FORM ACTION PHASE (CONTINUOUS)
   User: Types "TÃ´i tÃ¬m kiáº¿m quanh phÃ²ng" trong private channel
   Bot:
   â”œâ”€ on_message listener intercepts
   â”œâ”€ Call process_free_text_action() vá»›i full context
   â”œâ”€ LLM processes action (per-user isolated context):
   â”‚  â””â”€ Receives: location desc, inventory, stats, last 5 messages history
   â”œâ”€ Update database: hp, sanity, location, inventory, conversation_history
   â”œâ”€ Check for encounters: get_players_at_location()
   â”‚  â””â”€ If 2+ players at same location => generate_encounter()
   â”‚  â””â”€ Send encounter message to all players at location
   â”œâ”€ Update real-time dashboard (edit single message)
   â””â”€ Send response to player's private channel (embed + stats delta)

5. ENCOUNTER SYSTEM (AUTOMATIC)
   When 2+ players at same location:
   â”œâ”€ Detect from get_players_at_location(game_id, location_id)
   â”œâ”€ Generate LLM encounter text
   â”œâ”€ Send encounter message to both players' private channels
   â”œâ”€ Record to player_encounters table
   â””â”€ Can lead to cooperative or conflicting outcomes (LLM decides)

6. ENDGAME PHASE
   Creator: /endgame => End immediately + cleanup
   Player: /endgame => Vote (50%+ to pass) + cleanup on pass
   Cleanup:
   â”œâ”€ Stop all listeners
   â”œâ”€ Delete tá»« active_games, players, game_maps, game_rules, game_context
   â”œâ”€ Delete all 3-tier channels
   â””â”€ Return to waiting for next game

================================================================================
ğŸ”‘ KEY MECHANICS - Per-User Architecture
================================================================================

3-TIER CHANNEL SYSTEM (Solves Context Length Issues):
â”œâ”€ Tier 1 (Lobby):
â”‚  â”œâ”€ Shared lore, scenario description
â”‚  â”œâ”€ Join interface, player list
â”‚  â””â”€ Visible to all players in game
â”œâ”€ Tier 2 (Dashboard):
â”‚  â”œâ”€ Real-time stats (HP, Sanity, Location for each player)
â”‚  â”œâ”€ Single message edited continuously
â”‚  â”œâ”€ Read-only (prevents chat spam)
â”‚  â””â”€ System updates automatically after each action
â””â”€ Tier 3 (Private Per-User):
   â”œâ”€ Each player has own private-[name]-[id] channel
   â”œâ”€ Free-form text actions
   â”œâ”€ Per-user LLM conversation history (10-message rolling window)
   â”œâ”€ Individual scene descriptions and action results
   â””â”€ Encounter messages when meeting other players

PER-USER LLM CONVERSATION HISTORY (10-Message Rolling Window):
â”œâ”€ Stored in players.llm_conversation_history (JSON)
â”œâ”€ Format: [{role: "user"|"assistant", content: text}]
â”œâ”€ Function append_to_llm_history(user_id, game_id, role, message):
â”‚  â””â”€ Adds message, keeps last 10 (old messages discarded)
â”œâ”€ Benefits:
â”‚  â”œâ”€ Prevents context overflow (vs shared 1000-message history)
â”‚  â”œâ”€ Per-user memory prevents cross-player state leakage
â”‚  â”œâ”€ LLM can reference recent actions ("You just found a key...")
â”‚  â””â”€ CPU-efficient (8192 context token window plenty for 10 messages)
â””â”€ Used in llm_service.process_player_action():
   â””â”€ Builds prompt with last 5 messages for context

FREE-FORM TEXT ACTIONS (Natural Language Processing):
â”œâ”€ Player types arbitrary action: "TÃ´i tÃ¬m kiáº¿m...", "TÃ´i táº¥n cÃ´ng...", etc
â”œâ”€ LLM processes with system prompt tailored to:
â”‚  â”œâ”€ Current scenario type
â”‚  â”œâ”€ Current location description
â”‚  â”œâ”€ Player inventory, stats
â”‚  â””â”€ Recent action history (last 5 messages)
â”œâ”€ LLM returns JSON:
â”‚  â”œâ”€ success (bool): Did action succeed?
â”‚  â”œâ”€ description (str): What happened?
â”‚  â”œâ”€ hp_change (int): Damage/healing
â”‚  â”œâ”€ sanity_change (int): Sanity delta
â”‚  â”œâ”€ new_location_id (str): Did player move?
â”‚  â””â”€ discovered_items (list): Any items found?
â””â”€ No button constraints, player creativity rewarded

AUTOMATIC ENCOUNTER DETECTION:
â”œâ”€ After each action, check get_players_at_location(game_id, location_id)
â”œâ”€ If 2+ players (hp > 0) at same location:
â”‚  â”œâ”€ Generate encounter scenario via LLM
â”‚  â”œâ”€ Determine if cooperative or hostile
â”‚  â”œâ”€ Send message to both players' private channels
â”‚  â””â”€ Record to player_encounters table
â”œâ”€ Can happen spontaneously (no manual trigger needed)
â””â”€ Encourages emergent multiplayer moments

REAL-TIME DASHBOARD UPDATES:
â”œâ”€ Single message per game in dashboard channel
â”œâ”€ After each action, update_game_dashboard() re-renders:
â”‚  â”œâ”€ All players' current locations
â”‚  â”œâ”€ HP bars [â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘]
â”‚  â”œâ”€ Sanity bars [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘]
â”‚  â”œâ”€ Status (alive/dead/left)
â”‚  â””â”€ Last action timestamp
â”œâ”€ Edits in-place (no new message spam)
â”œâ”€ Players see others' status in real-time

CONVERSATION HISTORY MANAGEMENT:
â”œâ”€ Per-user isolated history prevents context leakage
â”œâ”€ Rolling 10-message window:
â”‚  â”œâ”€ Message 1: "I enter a dark room"
â”‚  â”œâ”€ Message 2: "I search for items"
â”‚  â”œâ”€ ...
â”‚  â”œâ”€ Message 10: "I open a chest"
â”‚  â”œâ”€ Message 11: (old message 1 deleted, new message added)
â”‚  â””â”€ Max keeps last 10
â”œâ”€ Allows LLM to reference context:
â”‚  â”œâ”€ "You already found a key in the previous room"
â”‚  â”œâ”€ "You're getting tired from running"
â”‚  â””â”€ Without information explosion

================================================================================
âš™ï¸ TECHNICAL ARCHITECTURE
================================================================================

ASYNC/AWAIT PATTERN:
â”œâ”€ ToÃ n bá»™ bot sá»­ dá»¥ng asyncio
â”œâ”€ aiosqlite for non-blocking database access
â”œâ”€ asyncio.wait_for() cho LLM timeout (30s)
â”œâ”€ Per-player message listeners don't block main event loop

DATABASE DESIGN:
â”œâ”€ aiosqlite (SQLite async driver)
â”œâ”€ 7 tables: active_games, game_setups, game_maps, players, game_rules,
â”‚            game_context, player_encounters
â”œâ”€ Key fields:
â”‚  â”œâ”€ game_id: UUID (primary key, not channel_id)
â”‚  â”œâ”€ players.private_channel_id: Tier 3 channel ID (per-user)
â”‚  â”œâ”€ players.llm_conversation_history: JSON rolling 10-message history
â”‚  â”œâ”€ active_games.dashboard_message_id: For in-place edits
â”‚  â””â”€ player_encounters.player_ids: JSON array for encounter tracking
â”œâ”€ Transactions: await db.commit() for atomic updates

LLM INTEGRATION (PER-USER ISOLATED):
â”œâ”€ Model: Qwen-1.5B GGUF (4.5GB)
â”œâ”€ Library: llama-cpp-python
â”œâ”€ Context: 8192 tokens (larger for future expansion)
â”œâ”€ Loading: load_llm() once in main.py on_ready()
â”œâ”€ Per-Player System Prompt:
â”‚  â”œâ”€ Scenario context (hospital, ghost village, etc)
â”‚  â”œâ”€ Current location description (from map)
â”‚  â”œâ”€ Player stats (hp, sanity, agi, acc)
â”‚  â”œâ”€ Inventory items
â”‚  â”œâ”€ Conversation history (last 5 messages)
â”‚  â””â”€ Ensures each player gets tailored responses
â”œâ”€ Output Format: JSON with success, description, stat changes, etc
â”œâ”€ Timeout: 30 seconds with graceful fallback

UI/UX DESIGN:
â”œâ”€ No emoji reactions (pure natural language)
â”œâ”€ Plain text private channels (free-form input)
â”œâ”€ Real-time dashboard updates (single edited message)
â”œâ”€ Embeds for action results (stats delta, description)
â”œâ”€ Text chunking (<2000 char limit Discord)
â”œâ”€ No turn-based waiting (continuous free-form play)

DISCORD.PY STRUCTURE:
â”œâ”€ Cogs pattern (game_commands, admin_commands, game_ui)
â”œâ”€ Slash commands (/ prefix)
â”œâ”€ on_message event listener (for free-text action routing)
â”œâ”€ Per-channel context (each player's private channel)
â”œâ”€ Permission checks (create channels, manage roles)
â”œâ”€ Message content intent required (intents.message_content = True)

STATE MANAGEMENT:
â”œâ”€ Database as source of truth
â”œâ”€ No in-memory TurnManager (continuous play, no turns)
â”œâ”€ Stateless message handlers (all state in DB)
â”œâ”€ Per-user context: private_channel_id + llm_conversation_history

================================================================================
ğŸ“Š DATA FLOW DIAGRAM (Free-Form Action Pipeline)
================================================================================

User Types in Private Channel
    â†“
on_message Event Listener (game_commands.py)
    â†“
Fetch Player Context (db_manager)
    â”œâ”€ Current location, inventory, stats
    â””â”€ Conversation history (last 10 messages)
    â†“
LLM Inference (llm_service.process_player_action)
    â”œâ”€ System prompt (scenario + location + stats)
    â”œâ”€ Input: action text + conversation context
    â””â”€ Output: JSON {success, description, hp_change, sanity_change, new_location, items}
    â†“
Database Update (db_manager - ATOMIC)
    â”œâ”€ Update stats (hp, sanity, clamped 0-100)
    â”œâ”€ Update location
    â”œâ”€ Append to conversation history (rolling 10 messages)
    â””â”€ Record action_result
    â†“
Encounter Check
    â”œâ”€ Query get_players_at_location()
    â””â”€ If 2+: Generate encounter, send to both players
    â†“
Dashboard Update (game_engine.update_game_dashboard)
    â””â”€ Edit dashboard message with all players' stats
    â†“
Response to Player
    â””â”€ Send embed to private channel with description + stats delta
    â†“
User sees Result in Private Channel + Dashboard Updates

================================================================================
ğŸ› ï¸ DEPENDENCIES & REQUIREMENTS
================================================================================

1. discord.py (2.0+)
   â””â”€ Discord API wrapper, message intents, on_message events

2. python-dotenv
   â””â”€ Load DISCORD_TOKEN, LLM_MODEL_PATH tá»« .env

3. aiosqlite
   â””â”€ Async SQLite driver, non-blocking queries

4. llama-cpp-python
   â””â”€ Local LLM inference (Qwen-1.5B GGUF)

5. huggingface-hub
   â””â”€ Download models tá»« Hugging Face

Python version: 3.9+ (asyncio, type hints, f-strings)

================================================================================
ğŸ’¡ DESIGN DECISIONS & OPTIMIZATIONS
================================================================================

1. 3-TIER CHANNEL ARCHITECTURE:
   âœ“ Tier 1 (Lobby): Shared lore prevents duplication
   âœ“ Tier 2 (Dashboard): Read-only prevents accidental chat
   âœ“ Tier 3 (Private): Per-user isolation prevents context leakage
   â””â”€ Result: Scalable to many players without token explosion

2. PER-USER CONVERSATION HISTORY (10-MESSAGE WINDOW):
   âœ“ Context management without memory inflation
   âœ“ Individual player context prevents cross-talk
   âœ“ LLM can still reference recent actions
   â””â”€ Result: 8192 token context never exceeded, CPU-efficient

3. FREE-FORM TEXT ACTIONS:
   âœ“ Natural language > rigid button menus
   âœ“ Encourages creative problem-solving
   âœ“ LLM processes intent directly
   â””â”€ Result: More engaging, replayable gameplay

4. AUTOMATIC ENCOUNTER DETECTION:
   âœ“ Location-based triggers (location_id matching)
   âœ“ No manual intervention needed
   âœ“ LLM generates dynamic interactions
   â””â”€ Result: Emergent multiplayer moments

5. REAL-TIME DASHBOARD (Single Edited Message):
   âœ“ No message spam in dashboard channel
   âœ“ Updates visible immediately
   âœ“ Discord rate-limit friendly (edit < create)
   â””â”€ Result: Clean UI, fast feedback

6. DATABASE AS SOURCE OF TRUTH:
   âœ“ Stateless message handlers
   âœ“ Bot restart safety (all state persisted)
   âœ“ Multi-process capable (future scaling)
   â””â”€ Result: Reliable, crash-resistant

================================================================================
ğŸš€ HOW TO RUN (Updated for Free-Form Architecture)
================================================================================

1. Install dependencies:
   pip install -r requirements.txt

2. Download model:
   python download_model.py

3. Setup .env:
   DISCORD_TOKEN=your_token_here
   LLM_MODEL_PATH=/path/to/model.gguf
   LLM_N_THREADS=4
   LLM_CONTEXT_SIZE=8192

4. Update main.py to load v4 cogs:
   await bot.load_extension("cogs.game_commands")  # Now uses game_commands v4

5. Run bot:
   python main.py

6. In Discord:
   - Admin: /setup [category]
   - User: /newgame [scenario]
   - User: Click START button (creates Tier 3 private channel)
   - User: Type free-form action in private channel
   - Example actions:
     â€¢ "TÃ´i tÃ¬m kiáº¿m quanh phÃ²ng"
     â€¢ "TÃ´i táº¥n cÃ´ng con quÃ¡i"
     â€¢ "TÃ´i cháº¡y vá» phÃ­a cá»­a"
   - User: /endgame to end game

================================================================================
ğŸ“ NOTES
================================================================================

âœ“ Bot cáº§n permission: Create Channels, Manage Roles, Send Messages, Read Message History
âœ“ SQLite Ä‘Æ°á»£c sá»­ dá»¥ng vÃ¬ project lÃ  small-scale local
âœ“ LLM cháº¡y CPU-only (no GPU)
âœ“ Free-form text actions thay vÃ¬ button menus (more natural)
âœ“ Per-user sessions prevent context overflow (critical for group games)
âœ“ Conversation history rolling window (10 messages) balances memory vs context
âœ“ Automatic encounter detection creates emergent multiplayer
âœ“ Real-time dashboard keeps UI clean (single edited message)
âœ“ Database atomic updates ensure consistency (no partial failures)

================================================================================
