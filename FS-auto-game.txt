Role: Báº¡n lÃ  Senior Python FUll Stack Developer.


Task: Táº¡o cáº¥u trÃºc dá»± Ã¡n vÃ  code base khung (boilerplate) cho má»™t Discord Bot Game RPG Kinh Dá»‹ (Text-based). Environment: VPS Linux, Python 3.10+, CPU Only (Xeon), 16GB RAM. KhÃ´ng dÃ¹ng Docker. Libraries: discord.py, llama-cpp-python, aiosqlite (Báº¯t buá»™c dÃ¹ng async DB).
+1

HÃ£y Ä‘á»c ká»¹ Ä‘áº·c táº£ ká»¹ thuáº­t dÆ°á»›i Ä‘Ã¢y vÃ  generate code.

1. MÃ´ táº£ dá»± Ã¡n & CÆ¡ cháº¿ Game (Project Overview)
Há»‡ thá»‘ng lÃ  má»™t bot Discord quáº£n trÃ² (Game Master) cho game kinh dá»‹ sinh tá»“n, káº¿t há»£p giá»¯a thuáº­t toÃ¡n ngáº«u nhiÃªn (RNG) vÃ  AI (LLM) Ä‘á»ƒ mÃ´ táº£ láº¡i vÄƒn báº£n.
+1


Core Gameplay: Turn-based (Theo lÆ°á»£t) káº¿t há»£p vá»›i Real-time Countdown.


Procedural Map: Há»‡ thá»‘ng map phÃ¢n cáº¥p (Hierarchical), sinh ngáº«u nhiÃªn sá»‘ táº§ng vÃ  sá»‘ phÃ²ng dá»±a trÃªn file config.
+2

Stats System: Há»‡ thá»‘ng chá»‰ sá»‘ RPG (HP, Sanity, Agility, Accuracy) áº£nh hÆ°á»Ÿng Ä‘áº¿n káº¿t quáº£ hÃ nh Ä‘á»™ng.

Interaction Flow (UI/UX):

Hiá»ƒn thá»‹: Sá»­ dá»¥ng Discord Embed Ä‘á»ƒ lÃ m Dashboard (luÃ´n Ä‘Æ°á»£c cáº­p nháº­t hoáº·c gá»­i má»›i sau má»—i lÆ°á»£t).

Thao tÃ¡c: Sá»­ dá»¥ng Discord Buttons cho cÃ¡c hÃ nh Ä‘á»™ng.

Pháº£n há»“i: Bot pháº£n há»“i ephemeral=True (chá»‰ ngÆ°á»i báº¥m tháº¥y) Ä‘á»ƒ xÃ¡c nháº­n hÃ nh Ä‘á»™ng, trÃ¡nh spam kÃªnh chat.

Timeout: Má»—i lÆ°á»£t cÃ³ giá»›i háº¡n thá»i gian (vÃ­ dá»¥: 60s). Háº¿t giá» sáº½ kÃ­ch hoáº¡t hÃ¬nh pháº¡t (Penalty) cho ngÆ°á»i chÆ°a hÃ nh Ä‘á»™ng.

2. Cáº¥u trÃºc thÆ° má»¥c (Directory Structure)
Dá»±a trÃªn cáº¥u trÃºc cÆ¡ báº£n Ä‘Ã£ cÃ³, bá»• sung thÃªm cÃ¡c module UI vÃ  dá»¯ liá»‡u RPG:

Plaintext

horror_bot/
â”œâ”€â”€ .env
â”œâ”€â”€ requirements.txt
â”œâ”€â”€ main.py
â”œâ”€â”€ config.py
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ scenarios/          # hotel.json, hospital.json [cite: 10]
â”‚   â”œâ”€â”€ backgrounds.json    # [NEW] Äá»‹nh nghÄ©a Class nhÃ¢n váº­t (Police, Athlete...)
â”‚   â”œâ”€â”€ descriptions/       # rooms.txt, smells.txt [cite: 11]
â”‚   â””â”€â”€ entities/           # ghosts.txt, creatures.txt [cite: 11]
â”œâ”€â”€ database/
â”‚   â”œâ”€â”€ db_manager.py       # Async SQLite connection [cite: 12]
â”‚   â””â”€â”€ schema.sql
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ llm_service.py      # AI Wrapper (LlamaCPP) [cite: 12]
â”‚   â”œâ”€â”€ map_generator.py    # Logic sinh Map Node [cite: 12]
â”‚   â””â”€â”€ game_engine.py      # Logic chÃ­nh: Turn, Stats, Penalty [cite: 12]
â””â”€â”€ cogs/
    â”œâ”€â”€ game_ui.py          # [NEW] Chá»©a Class View, Button, Embed
    â”œâ”€â”€ game_commands.py    # Lá»‡nh slash: /newgame, /join
    â””â”€â”€ admin_commands.py   # Lá»‡nh debug [cite: 13]
3. Chi tiáº¿t Logic & Classes (Implementation Details)
A. Module: services/game_engine.py (Core Logic)
Má»Ÿ rá»™ng logic quáº£n lÃ½ state ngÆ°á»i chÆ¡i vÃ  xá»­ lÃ½ lÆ°á»£t:

Class TurnManager:

start_turn(game_id): Báº¯t Ä‘áº§u Ä‘áº¿m ngÆ°á»£c (asyncio.sleep).

handle_player_action(user_id, action_type): Ghi nháº­n ngÆ°á»i chÆ¡i Ä‘Ã£ hÃ nh Ä‘á»™ng. Náº¿u táº¥t cáº£ Ä‘Ã£ xong -> Há»§y timer -> Gá»i process_turn_results.

apply_timeout_penalty(): Trá»« HP/Sanity cá»§a nhá»¯ng ngÆ°á»i cÃ³ has_acted=False khi háº¿t giá».

HÃ m tÃ­nh toÃ¡n RPG (RNG + Stats):

calculate_hit(player_acc, monster_evasion): TÃ­nh tá»‰ lá»‡ trÃºng.

calculate_flee(player_agi): TÃ­nh tá»‰ lá»‡ cháº¡y thoÃ¡t dá»±a trÃªn chá»‰ sá»‘ Agility.

B. Module: cogs/game_ui.py (UI & Interaction)
ÄÃ¢y lÃ  pháº§n hiá»ƒn thá»‹ giao diá»‡n ngÆ°á»i dÃ¹ng:

Class GameDashboard(discord.Embed):

Hiá»ƒn thá»‹ tÃ¬nh huá»‘ng hiá»‡n táº¡i (Text do AI mÃ´ táº£).

Hiá»ƒn thá»‹ thanh tráº¡ng thÃ¡i (Progress Bar) cho HP vÃ  Sanity.

Hiá»ƒn thá»‹ danh sÃ¡ch ngÆ°á»i chÆ¡i vÃ  tráº¡ng thÃ¡i (ÄÃ£ xong lÆ°á»£t / ChÆ°a xong).

Class ActionView(discord.ui.View):

Chá»©a cÃ¡c nÃºt: [âš”ï¸ Attack], [ğŸƒ Flee], [ğŸ” Search].

Logic Ephemeral:

Python

@discord.ui.button(label="Attack")
async def attack(self, interaction, button):
    await interaction.response.send_message("Báº¡n Ä‘Ã£ chá»n Táº¥n cÃ´ng! Äang chá» Ä‘á»“ng Ä‘á»™i...", ephemeral=True)
    await game_engine.register_action(interaction.user.id, "attack")
C. Module: services/map_generator.py

Class MapNode & MapStructure:

Äá»c file JSON config (vÃ­ dá»¥ hotel.json).
+1

Random sá»‘ táº§ng (min_floors - max_floors) vÃ  sá»‘ phÃ²ng má»—i táº§ng.
+1

GÃ¡n sáºµn quÃ¡i váº­t/sá»± kiá»‡n vÃ o Node ngay khi khá»Ÿi táº¡o.

D. Module: services/llm_service.py
Sá»­ dá»¥ng llama_cpp.Llama vá»›i n_threads tá»‘i Ä‘a Ä‘á»ƒ cháº¡y trÃªn CPU.

HÃ m describe_scene: Nháº­n keywords (context), tráº£ vá» Ä‘oáº¡n vÄƒn mÃ´ táº£ ngáº¯n gá»n (<50 tá»«).

4. SÆ¡ Ä‘á»“ dá»¯ liá»‡u (Database Schema - SQLite)
Cáº­p nháº­t Schema Ä‘á»ƒ há»— trá»£ Timeout vÃ  Stats RPG.

SQL

-- Báº£ng quáº£n lÃ½ phiÃªn chÆ¡i
CREATE TABLE active_games (
    channel_id INTEGER PRIMARY KEY,
    host_id INTEGER,
    scenario_type TEXT,
    current_turn INTEGER DEFAULT 0,
    turn_deadline_ts REAL, -- [NEW] Timestamp thá»i Ä‘iá»ƒm háº¿t giá»
    is_active BOOLEAN DEFAULT 1
);

-- Báº£ng lÆ°u Map (JSON)
CREATE TABLE game_maps (
    game_id INTEGER,
    map_data JSON, -- Cáº¥u trÃºc cÃ¢y node [cite: 24]
    FOREIGN KEY(game_id) REFERENCES active_games(channel_id)
);

-- Báº£ng ngÆ°á»i chÆ¡i & Chá»‰ sá»‘
CREATE TABLE players (
    user_id INTEGER,
    game_id INTEGER,
    
    -- Chá»‰ sá»‘ cÆ¡ báº£n
    hp INTEGER DEFAULT 100,
    sanity INTEGER DEFAULT 100[cite: 25],
    
    -- Chá»‰ sá»‘ RPG & Background [NEW]
    agi INTEGER DEFAULT 50, -- Agility (Tá»‘c Ä‘á»™/Cháº¡y trá»‘n)
    acc INTEGER DEFAULT 50, -- Accuracy (ChÃ­nh xÃ¡c)
    background_id TEXT,     -- ID nghá» nghiá»‡p (police, doctor...)
    
    -- Tráº¡ng thÃ¡i lÆ°á»£t
    has_acted_this_turn BOOLEAN DEFAULT 0, -- Check Ä‘á»ƒ xá»­ lÃ½ Timeout
    
    current_location_id TEXT,
    inventory JSON,
    PRIMARY KEY(user_id, game_id)
);
5. YÃªu cáº§u Code Generation (Instruction for Agent)

Map Logic: Viáº¿t hÃ m generate_map_structure Ä‘á»c config JSON vÃ  táº¡o Ä‘á»“ thá»‹ Map.


AI Integration: Viáº¿t hÃ m cháº¡y llama_cpp trong executor (thread pool) Ä‘á»ƒ trÃ¡nh cháº·n main thread cá»§a bot.

UI Logic: Trong game_ui.py, táº¡o View vá»›i cÃ¡c Button tráº£ vá» ephemeral=True.

Async Timer: Trong game_engine.py, viáº¿t hÃ m countdown_timer dÃ¹ng asyncio Ä‘á»ƒ xá»­ lÃ½ Timeout vÃ  gá»i hÃ m pháº¡t apply_penalty náº¿u ngÆ°á»i chÆ¡i AFK.


Data Loading: Viáº¿t hÃ m utility Ä‘á»c ngáº«u nhiÃªn cÃ¡c file .txt (description/entities) Ä‘á»ƒ trá»™n ná»™i dung cho AI viáº¿t vÄƒn.